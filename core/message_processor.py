import re
import base64
from pathlib import Path
from langbot_plugin.api.entities.builtin.platform import message as platform_message


class MessageProcessor:
    @staticmethod
    def convert_message(message, sender_id, need_at=False):
        """
        将消息文本转换为消息链对象，支持解析文本、网络图片和本地路径图片

        Args:
            message (str): 消息文本内容
            sender_id (str): 发送者ID，用于处理@功能
            need_at (bool): 是否需要@用户，默认为False

        Returns:
            list: 包含消息链元素的列表
        """
        parts = []
        last_end = 0
        Inimage = False
        # 匹配 Markdown 格式的网络图片 ![alt](http://...)
        image_pattern = re.compile(r'!\[.*?\]\((https?://\S+)\)')
        # 匹配本地绝对路径
        local_image_pattern = re.compile(r'(/home/.*?\.png)')
        # 处理@功能
        if need_at:
            parts.append(platform_message.At(target=sender_id))

        # 处理网络图片 (Markdown 形式)
        for match in image_pattern.finditer(message):
            Inimage = True
            start, end = match.span()
            if start > last_end:
                parts.append(platform_message.Plain(text=message[last_end:start]))
            image_url = match.group(1)
            parts.append(platform_message.Image(url=image_url))  # ✅ 直接 url=URL
            last_end = end

        # 处理剩余文本
        if last_end + 1 < len(message) and Inimage:
            parts.append(platform_message.Plain(text=message[last_end:]))
        elif not Inimage:
            parts.append(platform_message.Plain(text=message))

        # 处理本地图片路径
        for match in local_image_pattern.finditer(message):
            full_base64 = 'data:image/png;base64,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'
            return [platform_message.Image(base64=full_base64)]
            # return [platform_message.Image(url = 'https://static.moontung.top/2024/202405141832929.jpeg')]
            print(f'match={local_image_pattern.finditer(message)}')
            image_path = Path(match.group(1))
            print(image_path)
            if image_path.exists():
                print(f'parts={parts}')
                try:
                    with open(image_path, 'rb') as img_file:
                        img_bytes = img_file.read()
                        img_base64 = base64.b64encode(img_bytes).decode('utf-8')
                    return [platform_message.Image(base64=img_base64)]
                except Exception as e:
                    return [platform_message.Plain(text=f"[Error loading image: {e}]")]

        return parts if parts else [platform_message.Plain(text=message)]